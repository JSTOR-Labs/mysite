<!DOCTYPE html>
<html>
<head>
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@4.x/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
  <link href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
  <style>
    [v-cloak] { display: none; }
    #map { height: 1000px; }
  </style>
</head>
<body>
    <div id="map" :style="style"></div>

  <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
  <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>

  <script>
    const baseLayers = {
      'OpenStreetMap': ['https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
            { maxZoom: 18, attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>' }],
      'Esri_WorldPhysical': ['https://server.arcgisonline.com/ArcGIS/rest/services/World_Physical_Map/MapServer/tile/{z}/{y}/{x}', 
            { maxZoom: 8, attribution: 'Tiles &copy; Esri &mdash; Source: US National Park Service' }],
      'OpenTopoMap': ['https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',
            { maxZoom: 17, attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)' }],
      'Stamen_Watercolor': ['https://stamen-tiles-{s}.a.ssl.fastly.net/watercolor/{z}/{x}/{y}.{ext}',
            {	subdomains: 'abcd', minZoom: 1, maxZoom: 16, ext: 'jpg', attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors' }]
    }
  
    Vue.prototype.$L = L

    window.app = new Vue({
      el: '#app',
      vuetify: new Vuetify(),
      data: () => ({
        map: undefined,
        baseMap: 'Esri_WorldPhysical',
        style: {
          height: undefined
        },
        cache: {}
      }),
      computed: {
      },
      created() {
        this.style.height = Math.max(document.documentElement.clientHeight, window.innerHeight || 0)
        this.map = this.$L.map('map', {
          center: [25, 0],
          zoom: 2.5, zoomSnap: 0.1,
          layers: [ this.$L.tileLayer(...baseLayers[this.baseMap]) ]
        })
      },
      mounted() {
        fetch('https://plant-humanities.app/specimens/Prunus_serrulata?refresh').then(resp => resp.json())
        .then(resp => {
          console.log(resp)
          resp.specimens.forEach(specimen => {
            if (specimen.locationCollected && specimen.locationCollected.geojson) {
              this.cachingFetch(specimen.locationCollected.geojson)
              .then(geojson => L.geoJson(geojson).addTo(this.map))
            }
          })
        })
      },
      methods: {
        cachingFetch(url) {
          if (!this.cache[url]) {
            console.log(url)
            this.cache[url] = fetch(url).then((resp) => resp.ok ? resp.json() : null)
          }
          return this.cache[url]
        }
      },
      watch: {
      }
    })
  </script>
</body>
</html>